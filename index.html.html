<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spend & Vendor Management</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #1e3a8a;
            --secondary-blue: #3b82f6;
            --light-blue: #eff6ff;
            --accent-red: #ef4444;
            --accent-green: #10b981;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --radius: 12px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-dark);
            padding-bottom: 80px;
            min-height: 100vh;
        }

        header {
            background-color: var(--primary-blue);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .container {
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            border-top: 1px solid var(--border);
            z-index: 1000;
        }

        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            border: none;
            background: none;
            color: var(--text-light);
            cursor: pointer;
            flex: 1;
        }

        .tab-item.active {
            color: var(--primary-blue);
        }

        .tab-item span {
            font-size: 0.75rem;
            font-weight: 500;
            margin-top: 4px;
        }

        .toggle-group {
            display: flex;
            background: var(--light-blue);
            padding: 4px;
            border-radius: 100px;
            margin-bottom: 20px;
        }

        .toggle-btn {
            flex: 1;
            padding: 8px;
            border: none;
            background: transparent;
            border-radius: 100px;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
        }

        .toggle-btn.active {
            background: var(--primary-blue);
            color: white;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-box {
            background: var(--light-blue);
            padding: 12px;
            border-radius: var(--radius);
            text-align: center;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-light);
            text-transform: uppercase;
            font-weight: 600;
        }

        .stat-value {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--primary-blue);
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 4px;
            color: var(--text-light);
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-family: inherit;
            font-size: 1rem;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
        }

        .list-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .ledger-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .ledger-table th,
        .ledger-table td {
            text-align: left;
            padding: 8px 4px;
            border-bottom: 1px solid var(--border);
        }

        .text-red {
            color: var(--accent-red);
        }

        .text-green {
            color: var(--accent-green);
        }

        .fab {
            position: fixed;
            right: 20px;
            bottom: 100px;
            width: 56px;
            height: 56px;
            background: var(--primary-blue);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: none;
            cursor: pointer;
        }

        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 16px;
            border-radius: 100px;
            font-size: 0.875rem;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 2000;
        }

        #toast.show {
            opacity: 1;
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <div id="toast"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const STORAGE_KEY = 'spend-vendor-v1';

        const Icons = {
            Dashboard: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1" /><rect width="7" height="5" x="14" y="3" rx="1" /><rect width="7" height="9" x="14" y="12" rx="1" /><rect width="7" height="5" x="3" y="16" rx="1" /></svg>,
            Spend: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2v20" /><path d="m17 5-5-3-5 3" /><path d="m17 19-5 3-5-3" /><rect width="18" height="12" x="3" y="6" rx="2" /></svg>,
            Vendor: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14" /><path d="M12 5v14" /></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></svg>
        };

        const showToast = (msg) => {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        };

        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);

        const App = () => {
            const [data, setData] = useState({
                vendors: [],
                spends: [],
                bills: [],
                payments: []
            });
            const [activeTab, setActiveTab] = useState('dashboard');
            const [dashboardToggle, setDashboardToggle] = useState('spend');
            const [selectedVendorId, setSelectedVendorId] = useState('');
            const [isLoaded, setIsLoaded] = useState(false);

            useEffect(() => {
                const saved = window.storage ? window.storage.get(STORAGE_KEY) : localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    try {
                        setData(JSON.parse(saved));
                    } catch (e) { console.error("Load failed", e); }
                }
                setIsLoaded(true);
            }, []);

            useEffect(() => {
                if (isLoaded) {
                    const str = JSON.stringify(data);
                    if (window.storage) window.storage.set(STORAGE_KEY, str);
                    else localStorage.setItem(STORAGE_KEY, str);
                }
            }, [data, isLoaded]);

            // Helper methods (add basic ones first)
            const addVendor = (name, phone, note) => {
                const newVendor = { id: generateId(), name, phone, note };
                setData(prev => ({ ...prev, vendors: [...prev.vendors, newVendor] }));
                showToast("Vendor added!");
                return newVendor.id;
            };

            const addSpend = (vendorId, amount, category, date) => {
                const newSpend = { id: generateId(), vendorId, amount: Number(amount), category, date };
                setData(prev => ({ ...prev, spends: [newSpend, ...prev.spends] }));
                showToast("Spend saved!");
            };

            const addBill = (vendorId, category, date, items, total) => {
                const newBill = { id: generateId(), vendorId, category, date, items, total: Number(total) };
                setData(prev => ({ ...prev, bills: [newBill, ...prev.bills] }));
                showToast("Bill added!");
            };

            const addPayment = (vendorId, amount, date, note) => {
                const newPayment = { id: generateId(), vendorId, amount: Number(amount), date, note };
                setData(prev => ({ ...prev, payments: [newPayment, ...prev.payments] }));
                showToast("Payment recorded!");
            };

            if (!isLoaded) return null;

            return (
                <div>
                    <header>
                        <h1>Spend & Vendor Management</h1>
                    </header>

                    <main className="container">
                        {activeTab === 'dashboard' && (
                            <DashboardView
                                data={data}
                                toggle={dashboardToggle}
                                setToggle={setDashboardToggle}
                                selectedVendorId={selectedVendorId}
                                setSelectedVendorId={setSelectedVendorId}
                                addPayment={addPayment}
                            />
                        )}
                        {activeTab === 'spend' && <SpendView data={data} addSpend={addSpend} addVendor={addVendor} />}
                        {activeTab === 'vendor' && <VendorMasterView data={data} addVendor={addVendor} addBill={addBill} addPayment={addPayment} />}
                    </main>

                    <nav className="tab-bar">
                        <button className={`tab-item ${activeTab === 'dashboard' ? 'active' : ''}`} onClick={() => setActiveTab('dashboard')}>
                            <Icons.Dashboard />
                            <span>Dashboard</span>
                        </button>
                        <button className={`tab-item ${activeTab === 'spend' ? 'active' : ''}`} onClick={() => setActiveTab('spend')}>
                            <Icons.Spend />
                            <span>Spend</span>
                        </button>
                        <button className={`tab-item ${activeTab === 'vendor' ? 'active' : ''}`} onClick={() => setActiveTab('vendor')}>
                            <Icons.Vendor />
                            <span>Vendor</span>
                        </button>
                    </nav>
                </div>
            );
        };

        // Sub-components will go here (implemented in next steps)
        const DashboardView = ({ data, toggle, setToggle, selectedVendorId, setSelectedVendorId, addPayment }) => (
            <div>
                <div className="toggle-group">
                    <button className={`toggle-btn ${toggle === 'spend' ? 'active' : ''}`} onClick={() => setToggle('spend')}>Spend</button>
                    <button className={`toggle-btn ${toggle === 'vendor' ? 'active' : ''}`} onClick={() => setToggle('vendor')}>Vendor</button>
                </div>
                {toggle === 'spend' ? <SpendDashboard data={data} /> : <VendorDashboard data={data} selectedId={selectedVendorId} setSelectedId={setSelectedVendorId} addPayment={addPayment} />}
            </div>
        );

        const SpendDashboard = ({ data }) => {
            const today = new Date().toISOString().split('T')[0];
            const thisMonth = today.substring(0, 7);

            const todaySpend = data.spends.filter(s => s.date === today).reduce((sum, s) => sum + s.amount, 0);
            const monthlySpend = data.spends.filter(s => s.date.startsWith(thisMonth)).reduce((sum, s) => sum + s.amount, 0);

            const categories = data.spends.filter(s => s.date.startsWith(thisMonth)).reduce((acc, s) => {
                acc[s.category] = (acc[s.category] || 0) + s.amount;
                return acc;
            }, {});
            const topCategory = Object.entries(categories).sort((a, b) => b[1] - a[1])[0]?.[0] || 'None';

            return (
                <>
                    <div className="stat-grid">
                        <div className="stat-box">
                            <div className="stat-label">Today</div>
                            <div className="stat-value">₹{todaySpend}</div>
                        </div>
                        <div className="stat-box">
                            <div className="stat-label">This Month</div>
                            <div className="stat-value">₹{monthlySpend}</div>
                        </div>
                    </div>
                    <div className="card">
                        <div className="stat-label">Top Category</div>
                        <div className="stat-value">{topCategory}</div>
                    </div>
                    <h3>Recent Spends</h3>
                    <div className="card" style={{ padding: 0 }}>
                        {data.spends.slice(0, 5).map(s => (
                            <div key={s.id} className="list-item" style={{ padding: '12px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', fontWeight: 600 }}>
                                    <span>{data.vendors.find(v => v.id === s.vendorId)?.name || 'Generic'}</span>
                                    <span>₹{s.amount}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.8rem', color: 'var(--text-light)' }}>
                                    <span>{s.date}</span>
                                    <span>{s.category}</span>
                                </div>
                            </div>
                        ))}
                    </div>
                </>
            );
        };

        const VendorDashboard = ({ data, selectedId, setSelectedId, addPayment }) => {
            const [showPayForm, setShowPayForm] = useState(false);
            const vendor = data.vendors.find(v => v.id === selectedId);

            const ledger = useMemo(() => {
                if (!selectedId) return [];
                const items = [
                    ...data.bills.filter(b => b.vendorId === selectedId).map(b => ({ ...b, type: 'bill' })),
                    ...data.payments.filter(p => p.vendorId === selectedId).map(p => ({ ...p, type: 'payment' }))
                ].sort((a, b) => new Date(a.date) - new Date(b.date));

                let bal = 0;
                return items.map(item => {
                    if (item.type === 'bill') bal += item.total;
                    else bal -= item.amount;
                    return { ...item, balance: bal };
                });
            }, [data, selectedId]);

            const currentBalance = ledger[ledger.length - 1]?.balance || 0;

            return (
                <div>
                    <div className="form-group">
                        <label>Select Vendor</label>
                        <select value={selectedId} onChange={(e) => setSelectedId(e.target.value)}>
                            <option value="">-- Choose Vendor --</option>
                            {data.vendors.map(v => <option key={v.id} value={v.id}>{v.name}</option>)}
                        </select>
                    </div>

                    {vendor && (
                        <>
                            <div className="stat-grid">
                                <div className="stat-box">
                                    <div className="stat-label">Bills</div>
                                    <div className="stat-value">₹{data.bills.filter(b => b.vendorId === selectedId).reduce((sum, b) => sum + b.total, 0)}</div>
                                </div>
                                <div className="stat-box">
                                    <div className="stat-label">Paid</div>
                                    <div className="stat-value">₹{data.payments.filter(p => p.vendorId === selectedId).reduce((sum, p) => sum + p.amount, 0)}</div>
                                </div>
                            </div>
                            <div className="card" style={{ borderColor: currentBalance > 0 ? 'var(--accent-red)' : 'var(--accent-green)' }}>
                                <div className="stat-label">Current Balance</div>
                                <div className={`stat-value ${currentBalance > 0 ? 'text-red' : 'text-green'}`}>₹{Math.abs(currentBalance)} {currentBalance > 0 ? '(Due)' : '(Advance)'}</div>
                            </div>

                            <h3>Bahi-Khata Ledger</h3>
                            <div className="card" style={{ padding: '8px', overflowX: 'auto' }}>
                                <table className="ledger-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Detail</th>
                                            <th>Debit</th>
                                            <th>Credit</th>
                                            <th>Bal</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {ledger.slice().reverse().map(item => (
                                            <tr key={item.id}>
                                                <td>{item.date.substring(5)}</td>
                                                <td>{item.category || item.note || 'Payment'}</td>
                                                <td className="text-red">{item.type === 'bill' ? item.total : ''}</td>
                                                <td className="text-green">{item.type === 'payment' ? item.amount : ''}</td>
                                                <td style={{ fontWeight: 600 }}>₹{item.balance}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>

                            <button className="btn btn-primary" onClick={() => setShowPayForm(true)}>Add Payment</button>
                            {showPayForm && (
                                <div className="card" style={{ marginTop: '16px' }}>
                                    <h4>Record Payment</h4>
                                    <form onSubmit={(e) => {
                                        e.preventDefault();
                                        const form = e.target;
                                        addPayment(selectedId, form.amount.value, form.date.value, form.note.value);
                                        setShowPayForm(false);
                                    }}>
                                        <div className="form-group">
                                            <input name="amount" type="number" placeholder="Amount" required />
                                        </div>
                                        <div className="form-group">
                                            <input name="date" type="date" defaultValue={new Date().toISOString().split('T')[0]} required />
                                        </div>
                                        <div className="form-group">
                                            <input name="note" placeholder="Note (Cash, GPay, etc)" />
                                        </div>
                                        <div style={{ display: 'flex', gap: '8px' }}>
                                            <button type="submit" className="btn btn-primary">Save</button>
                                            <button type="button" className="btn" style={{ background: '#eee' }} onClick={() => setShowPayForm(false)}>Cancel</button>
                                        </div>
                                    </form>
                                </div>
                            )}
                        </>
                    )}
                </div>
            );
        };

        const SpendView = ({ data, addSpend, addVendor }) => {
            const [showAddVendor, setShowAddVendor] = useState(false);
            const [filter, setFilter] = useState('all');

            const filteredSpends = useMemo(() => {
                const now = new Date();
                const thisMonth = now.toISOString().substring(0, 7);
                const lastMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const lastMonth = lastMonthDate.toISOString().substring(0, 7);

                if (filter === 'this') return data.spends.filter(s => s.date.startsWith(thisMonth));
                if (filter === 'last') return data.spends.filter(s => s.date.startsWith(lastMonth));
                return data.spends;
            }, [data.spends, filter]);

            return (
                <div>
                    <div className="card">
                        <h3>New Spend</h3>
                        <form onSubmit={(e) => {
                            e.preventDefault();
                            const form = e.target;
                            addSpend(form.vendor.value, form.amount.value, form.category.value, form.date.value);
                            form.reset();
                        }}>
                            <div className="form-group">
                                <label>Vendor</label>
                                <div style={{ display: 'flex', gap: '8px' }}>
                                    <select name="vendor" required>
                                        <option value="">-- Select --</option>
                                        {data.vendors.map(v => <option key={v.id} value={v.id}>{v.name}</option>)}
                                    </select>
                                    <button type="button" className="btn" style={{ width: 'auto', background: 'var(--light-blue)', color: 'var(--primary-blue)' }} onClick={() => setShowAddVendor(true)}>+</button>
                                </div>
                            </div>
                            <div className="form-group">
                                <input name="amount" type="number" placeholder="Amount" required />
                            </div>
                            <div className="form-group">
                                <select name="category" required>
                                    <option value="Raw Material">Raw Material</option>
                                    <option value="Packaging">Packaging</option>
                                    <option value="Transport">Transport</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div className="form-group">
                                <input name="date" type="date" defaultValue={new Date().toISOString().split('T')[0]} required />
                            </div>
                            <button type="submit" className="btn btn-primary">Save Spend</button>
                        </form>
                    </div>

                    <div className="toggle-group">
                        <button className={`toggle-btn ${filter === 'all' ? 'active' : ''}`} onClick={() => setFilter('all')}>All</button>
                        <button className={`toggle-btn ${filter === 'this' ? 'active' : ''}`} onClick={() => setFilter('this')}>This Month</button>
                        <button className={`toggle-btn ${filter === 'last' ? 'active' : ''}`} onClick={() => setFilter('last')}>Last Month</button>
                    </div>

                    <div className="card" style={{ padding: 0 }}>
                        {filteredSpends.map(s => (
                            <div key={s.id} className="list-item" style={{ padding: '12px' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', fontWeight: 600 }}>
                                    <span>{data.vendors.find(v => v.id === s.vendorId)?.name || 'Generic'}</span>
                                    <span>₹{s.amount}</span>
                                </div>
                                <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.8rem', color: 'var(--text-light)' }}>
                                    <span>{s.date}</span>
                                    <span>{s.category}</span>
                                </div>
                            </div>
                        ))}
                    </div>

                    {showAddVendor && <AddVendorModal addVendor={addVendor} close={() => setShowAddVendor(false)} />}
                </div>
            );
        };

        const VendorMasterView = ({ data, addVendor, addBill, addPayment }) => {
            const [search, setSearch] = useState('');
            const [showAdd, setShowAdd] = useState(false);
            const [viewVendorId, setViewVendorId] = useState(null);

            const filteredVendors = data.vendors.filter(v => v.name.toLowerCase().includes(search.toLowerCase()));

            if (viewVendorId) {
                const vendor = data.vendors.find(v => v.id === viewVendorId);
                return <VendorDetailView vendor={vendor} data={data} addBill={addBill} addPayment={addPayment} back={() => setViewVendorId(null)} />;
            }

            return (
                <div>
                    <div style={{ display: 'flex', gap: '8px', marginBottom: '16px' }}>
                        <div style={{ position: 'relative', flex: 1 }}>
                            <span style={{ position: 'absolute', left: '10px', top: '50%', transform: 'translateY(-50%)', color: 'var(--text-light)' }}><Icons.Search /></span>
                            <input style={{ paddingLeft: '36px' }} placeholder="Search vendor..." value={search} onChange={e => setSearch(e.target.value)} />
                        </div>
                        <button className="btn btn-primary" style={{ width: 'auto' }} onClick={() => setShowAdd(true)}>+</button>
                    </div>

                    <div className="card" style={{ padding: 0 }}>
                        {filteredVendors.map(v => {
                            const bal = getBalance(v.id, data);
                            return (
                                <div key={v.id} className="list-item" style={{ padding: '16px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }} onClick={() => setViewVendorId(v.id)}>
                                    <div>
                                        <div style={{ fontWeight: 700 }}>{v.name}</div>
                                        <div style={{ fontSize: '0.8rem', color: 'var(--text-light)' }}>{v.phone || 'No phone'}</div>
                                    </div>
                                    <div className={bal > 0 ? 'text-red' : 'text-green'} style={{ fontWeight: 700 }}>₹{Math.abs(bal)}</div>
                                </div>
                            );
                        })}
                    </div>

                    {showAdd && <AddVendorModal addVendor={addVendor} close={() => setShowAdd(false)} />}
                </div>
            );
        };

        const VendorDetailView = ({ vendor, data, addBill, addPayment, back }) => {
            const [tab, setTab] = useState('ledger');
            const [showBill, setShowBill] = useState(false);

            const ledger = useMemo(() => {
                const items = [
                    ...data.bills.filter(b => b.vendorId === vendor.id).map(b => ({ ...b, type: 'bill' })),
                    ...data.payments.filter(p => p.vendorId === vendor.id).map(p => ({ ...p, type: 'payment' }))
                ].sort((a, b) => new Date(a.date) - new Date(b.date));

                let bal = 0;
                return items.map(item => {
                    if (item.type === 'bill') bal += item.total;
                    else bal -= item.amount;
                    return { ...item, balance: bal };
                });
            }, [data, vendor.id]);

            const currentBalance = ledger[ledger.length - 1]?.balance || 0;

            return (
                <div>
                    <button className="btn" style={{ width: 'auto', background: 'none', padding: '0 0 16px', color: 'var(--primary-blue)' }} onClick={back}>← Back to list</button>
                    <div className="card">
                        <h2 style={{ margin: '0 0 8px' }}>{vendor.name}</h2>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'baseline' }}>
                            <span className="stat-label">Closing Balance</span>
                            <span className={`stat-value ${currentBalance > 0 ? 'text-red' : 'text-green'}`}>₹{Math.abs(currentBalance)} {currentBalance > 0 ? '(Due)' : '(Advance)'}</span>
                        </div>
                    </div>

                    <div style={{ display: 'flex', gap: '8px', marginBottom: '16px' }}>
                        <button className="btn btn-primary" onClick={() => setShowBill(true)}>+ Add Bill</button>
                        <button className="btn" style={{ background: 'var(--light-blue)', color: 'var(--primary-blue)' }} onClick={() => {
                            const amt = prompt("Enter payment amount:");
                            if (amt) addPayment(vendor.id, amt, new Date().toISOString().split('T')[0], 'Direct payment');
                        }}>+ Add Payment</button>
                    </div>

                    <div className="card" style={{ padding: '8px', overflowX: 'auto' }}>
                        <table className="ledger-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Ref</th>
                                    <th>Debit</th>
                                    <th>Credit</th>
                                    <th>Bal</th>
                                </tr>
                            </thead>
                            <tbody>
                                {ledger.slice().reverse().map(item => (
                                    <tr key={item.id}>
                                        <td>{item.date.substring(5)}</td>
                                        <td>{item.category || item.note || 'Payment'}</td>
                                        <td className="text-red">{item.type === 'bill' ? item.total : ''}</td>
                                        <td className="text-green">{item.type === 'payment' ? item.amount : ''}</td>
                                        <td style={{ fontWeight: 600 }}>₹{item.balance}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {showBill && <AddBillModal vendorId={vendor.id} addBill={addBill} close={() => setShowBill(false)} />}
                </div>
            );
        };

        const AddVendorModal = ({ addVendor, close }) => {
            return (
                <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', zIndex: 3000, display: 'flex', alignItems: 'center', padding: '16px' }}>
                    <div className="card" style={{ width: '100%', maxWidth: '400px', margin: '0 auto' }}>
                        <h3>Add New Vendor</h3>
                        <form onSubmit={e => {
                            e.preventDefault();
                            addVendor(e.target.name.value, e.target.phone.value, e.target.note.value);
                            close();
                        }}>
                            <div className="form-group">
                                <label>Name</label>
                                <input name="name" required />
                            </div>
                            <div className="form-group">
                                <label>Phone</label>
                                <input name="phone" type="tel" />
                            </div>
                            <div className="form-group">
                                <label>Notes</label>
                                <textarea name="note" />
                            </div>
                            <div style={{ display: 'flex', gap: '8px' }}>
                                <button type="submit" className="btn btn-primary">Save Vendor</button>
                                <button type="button" className="btn" style={{ background: '#eee' }} onClick={close}>Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const AddBillModal = ({ vendorId, addBill, close }) => {
            const [items, setItems] = useState([{ id: 1, name: '', qty: 0, rate: 0, amount: 0 }]);

            const updateTotal = (idx, field, val) => {
                const newItems = [...items];
                newItems[idx][field] = val;
                if (field === 'qty' || field === 'rate') {
                    newItems[idx].amount = newItems[idx].qty * newItems[idx].rate;
                }
                setItems(newItems);
            };

            const grandTotal = items.reduce((sum, i) => sum + i.amount, 0);

            return (
                <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', zIndex: 3000, display: 'flex', alignItems: 'flex-start', padding: '16px', overflowY: 'auto' }}>
                    <div className="card" style={{ width: '100%', maxWidth: '450px', margin: '20px auto' }}>
                        <h3>New Bill</h3>
                        <form onSubmit={e => {
                            e.preventDefault();
                            addBill(vendorId, e.target.category.value, e.target.date.value, items, grandTotal);
                            close();
                        }}>
                            <div className="form-group">
                                <input name="date" type="date" defaultValue={new Date().toISOString().split('T')[0]} required />
                            </div>
                            <div className="form-group">
                                <select name="category">
                                    <option value="Raw Material">Raw Material</option>
                                    <option value="Packaging">Packaging</option>
                                    <option value="Transport">Transport</option>
                                </select>
                            </div>

                            <h4>Items</h4>
                            {items.map((item, idx) => (
                                <div key={item.id} style={{ display: 'grid', gridTemplateColumns: '2fr 1fr 1fr 1fr', gap: '4px', marginBottom: '8px', alignItems: 'center' }}>
                                    <input placeholder="Item" value={item.name} onChange={e => updateTotal(idx, 'name', e.target.value)} required />
                                    <input type="number" placeholder="Qty" value={item.qty} onChange={e => updateTotal(idx, 'qty', Number(e.target.value))} required />
                                    <input type="number" placeholder="Rate" value={item.rate} onChange={e => updateTotal(idx, 'rate', Number(e.target.value))} required />
                                    <div style={{ fontWeight: 700, textAlign: 'right' }}>₹{item.amount}</div>
                                </div>
                            ))}
                            <button type="button" className="btn" style={{ marginBottom: '16px', background: 'var(--light-blue)' }} onClick={() => setItems([...items, { id: Date.now(), name: '', qty: 0, rate: 0, amount: 0 }])}>+ Add Item</button>

                            <div style={{ fontSize: '1.2rem', fontWeight: 800, textAlign: 'right', marginBottom: '16px' }}>Total: ₹{grandTotal}</div>

                            <div style={{ display: 'flex', gap: '8px' }}>
                                <button type="submit" className="btn btn-primary">Save Bill</button>
                                <button type="button" className="btn" style={{ background: '#eee' }} onClick={close}>Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const getBalance = (vendorId, data) => {
            const bills = data.bills.filter(b => b.vendorId === vendorId).reduce((sum, b) => sum + b.total, 0);
            const payments = data.payments.filter(p => p.vendorId === vendorId).reduce((sum, p) => sum + p.amount, 0);
            return bills - payments;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>